name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  FLUTTER_VERSION: "3.35.3"

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      dart-changed: ${{ steps.changes.outputs.dart-changed }}
      example-changed: ${{ steps.changes.outputs.example-changed }}
      test-changed: ${{ steps.changes.outputs.test-changed }}
      core-changed: ${{ steps.changes.outputs.core-changed }}
      config-changed: ${{ steps.changes.outputs.config-changed }}
      test-summary: ${{ steps.changes.outputs.test-summary }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Detect changes and build strategy
      id: changes
      run: |
        # Determine base commit for comparison
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BASE_COMMIT="${{ github.event.pull_request.base.sha }}"
        else
          BASE_COMMIT="${{ github.event.before }}"
        fi

        # Get changed files
        CHANGED_FILES=$(git diff --name-only $BASE_COMMIT..HEAD)
        echo "Changed files:"
        echo "$CHANGED_FILES"

        # Initialize flags
        DART_CHANGED="false"
        EXAMPLE_CHANGED="false"
        TEST_CHANGED="false"
        CORE_CHANGED="false"
        CONFIG_CHANGED="false"

        # Detect changes by file patterns
        if echo "$CHANGED_FILES" | grep -q '\.dart$'; then
          DART_CHANGED="true"
        fi

        if echo "$CHANGED_FILES" | grep -q '^example/'; then
          EXAMPLE_CHANGED="true"
        fi

        if echo "$CHANGED_FILES" | grep -q '^test/.*\.dart$'; then
          TEST_CHANGED="true"
        fi

        # Core SDK files that require comprehensive testing
        if echo "$CHANGED_FILES" | grep -q '^lib/src/\(services\|security\|config\)/'; then
          CORE_CHANGED="true"
        fi

        # Config files that require full rebuild
        if echo "$CHANGED_FILES" | grep -q '\(pubspec\.yaml\|analysis_options\.yaml\|\.github/workflows/\)'; then
          CONFIG_CHANGED="true"
        fi

        # Build test summary
        if [ "$CONFIG_CHANGED" = "true" ]; then
          TEST_SUMMARY="ðŸ”„ Full suite (config changes detected)"
        elif [ "$CORE_CHANGED" = "true" ]; then
          TEST_SUMMARY="ðŸ§ª Core SDK testing (critical components changed)"
        elif [ "$DART_CHANGED" = "true" ]; then
          TEST_SUMMARY="ðŸŽ¯ Selective testing (Dart code changes)"
        else
          TEST_SUMMARY="âœ… No code changes - minimal checks"
        fi

        # Set outputs
        echo "dart-changed=$DART_CHANGED" >> $GITHUB_OUTPUT
        echo "example-changed=$EXAMPLE_CHANGED" >> $GITHUB_OUTPUT
        echo "test-changed=$TEST_CHANGED" >> $GITHUB_OUTPUT
        echo "core-changed=$CORE_CHANGED" >> $GITHUB_OUTPUT
        echo "config-changed=$CONFIG_CHANGED" >> $GITHUB_OUTPUT
        echo "test-summary=$TEST_SUMMARY" >> $GITHUB_OUTPUT

        echo "Change detection results:"
        echo "  Dart changed: $DART_CHANGED"
        echo "  Example changed: $EXAMPLE_CHANGED"
        echo "  Tests changed: $TEST_CHANGED"
        echo "  Core changed: $CORE_CHANGED"
        echo "  Config changed: $CONFIG_CHANGED"
        echo "  Strategy: $TEST_SUMMARY"

  analyze:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.dart-changed == 'true' || needs.detect-changes.outputs.config-changed == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true

    - name: Get dependencies
      run: flutter pub get

    - name: Run static analysis on SDK
      run: |
        echo "ðŸ” ${{ needs.detect-changes.outputs.test-summary }}"
        echo "Running static analysis on SDK..."
        flutter analyze lib/

    - name: Check code formatting
      run: |
        echo "ðŸŽ¨ Checking Dart code formatting..."
        if ! dart format --output=none --set-exit-if-changed lib/; then
          echo "âŒ Code formatting issues found"
          echo "Run 'dart format lib/' to fix formatting"
          exit 1
        fi

    - name: Analyze example app
      if: needs.detect-changes.outputs.example-changed == 'true'
      env:
        BASE_URL: ${{ secrets.BASE_URL }}
        ENDPOINT_VERIFY_VERSION: ${{ secrets.ENDPOINT_VERIFY_VERSION }}
        ENDPOINT_TEMPLATE_ZIP: ${{ secrets.ENDPOINT_TEMPLATE_ZIP }}
        ENDPOINT_LOOKUP: ${{ secrets.ENDPOINT_LOOKUP }}
        WILKERSTAT_BPS_KEY: ${{ secrets.WILKERSTAT_BPS_KEY }}
        WILKERSTAT_TOKEN: ${{ secrets.WILKERSTAT_TOKEN }}
      run: |
        echo "ðŸ” Analyzing example app..."
        cd example

        # Prepare .env file from template
        echo "ðŸ“ Setting up environment configuration..."
        cp .env.example .env

        # Replace placeholders with actual values from secrets
        sed -i "s|BASE_URL=.*|BASE_URL=$BASE_URL|g" .env
        sed -i "s|ENDPOINT_VERIFY_VERSION=.*|ENDPOINT_VERIFY_VERSION=$ENDPOINT_VERIFY_VERSION|g" .env
        sed -i "s|ENDPOINT_TEMPLATE_ZIP=.*|ENDPOINT_TEMPLATE_ZIP=$ENDPOINT_TEMPLATE_ZIP|g" .env
        sed -i "s|ENDPOINT_LOOKUP=.*|ENDPOINT_LOOKUP=$ENDPOINT_LOOKUP|g" .env
        sed -i "s|WILKERSTAT_BPS_KEY=.*|WILKERSTAT_BPS_KEY=$WILKERSTAT_BPS_KEY|g" .env
        sed -i "s|WILKERSTAT_TOKEN=.*|WILKERSTAT_TOKEN=$WILKERSTAT_TOKEN|g" .env

        flutter pub get
        dart run build_runner build -d
        flutter analyze

  test:
    runs-on: ubuntu-latest
    needs: [detect-changes, analyze]
    if: always() && (needs.detect-changes.outputs.dart-changed == 'true' || needs.detect-changes.outputs.test-changed == 'true' || needs.detect-changes.outputs.config-changed == 'true')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true

    - name: Get dependencies
      run: flutter pub get

    - name: Install lcov for coverage processing
      run: |
        sudo apt-get update
        sudo apt-get install -y lcov

    - name: Run unit tests and generate coverage
      run: |
        echo "ðŸ§ª ${{ needs.detect-changes.outputs.test-summary }}"

        # Determine coverage scope based on changes
        if [ "${{ needs.detect-changes.outputs.core-changed }}" = "true" ] || [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "Running full coverage analysis..."
          ./scripts/generate_coverage_report.sh --full --format markdown
        elif [ "${{ needs.detect-changes.outputs.dart-changed }}" = "true" ]; then
          echo "Running coverage for changed files only..."
          ./scripts/generate_coverage_report.sh --changed-only --base-branch develop --format markdown
        else
          echo "No Dart changes detected, running minimal tests..."
          ./scripts/generate_coverage_report.sh --format markdown
        fi

        # Rename the generated report for CI
        if [ -f "coverage_report.md" ]; then
          mv coverage_report.md test_report.md
        else
          # Fallback report if script fails
          echo "## ðŸ“Š Test Results" > test_report.md
          echo "" >> test_report.md
          echo "${{ needs.detect-changes.outputs.test-summary }}" >> test_report.md
          echo "" >> test_report.md
          echo "### âš ï¸ Coverage Report Generation Failed" >> test_report.md
          echo "The coverage script encountered an error. Please check the logs above." >> test_report.md
        fi

    - name: Comment PR with test results
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          let report = '';

          try {
            report = fs.readFileSync('test_report.md', 'utf8');
          } catch (error) {
            report = '## ðŸ“Š Test Results\n\nTests completed successfully.';
          }

          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.data.find(comment =>
            comment.user.type === 'Bot' && comment.body.includes('ðŸ“Š Test Results')
          );

          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: report
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });
          }


  ci-summary:
    runs-on: ubuntu-latest
    needs: [detect-changes, analyze, test]
    if: always()

    steps:
    - name: Generate CI summary
      run: |
        echo "## ðŸŽ¯ CI Summary" > summary.md
        echo "" >> summary.md
        echo "${{ needs.detect-changes.outputs.test-summary }}" >> summary.md
        echo "" >> summary.md

        echo "| Check | Status |" >> summary.md
        echo "|-------|--------|" >> summary.md

        # Analysis
        if [ "${{ needs.analyze.result }}" = "success" ]; then
          echo "| ðŸ” Analysis | âœ… Passed |" >> summary.md
        elif [ "${{ needs.analyze.result }}" = "skipped" ]; then
          echo "| ðŸ” Analysis | â­ï¸ Skipped |" >> summary.md
        else
          echo "| ðŸ” Analysis | âŒ Failed |" >> summary.md
        fi

        # Tests
        if [ "${{ needs.test.result }}" = "success" ]; then
          echo "| ðŸ§ª Tests | âœ… Passed |" >> summary.md
        elif [ "${{ needs.test.result }}" = "skipped" ]; then
          echo "| ðŸ§ª Tests | â­ï¸ Skipped |" >> summary.md
        else
          echo "| ðŸ§ª Tests | âŒ Failed |" >> summary.md
        fi

        echo "" >> summary.md

        # Overall status
        if [ "${{ needs.analyze.result }}" != "failure" ] && \
           [ "${{ needs.test.result }}" != "failure" ]; then
          echo "### âœ… All checks passed!" >> summary.md
        else
          echo "### âŒ Some checks failed" >> summary.md
        fi

    - name: Comment PR with summary
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('summary.md', 'utf8');

          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.data.find(comment =>
            comment.user.type === 'Bot' && comment.body.includes('ðŸŽ¯ CI Summary')
          );

          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: summary
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });
          }