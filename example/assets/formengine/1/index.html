<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />

    <title>FormGear</title>
    <style>
      /*style*/
    </style>
    <!-- <link rel="stylesheet" href="https://unpkg.com/form-gear/dist/style.css"> -->
  </head>

  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="FormGear-root"></div>
    <div id="FormGear-loader" class="bg-gray-200 dark:bg-[#181f30] absolute top-0 h-screen" style="display: none"></div>
    <script>
      window.addEventListener("DOMContentLoaded", function () {
        document.getElementById("FormGear-loader").style.display = "block";
      });
    </script>

    <script src="file:///android_asset/asset/jquery-3.5.1.js"></script>

    <script type="module">
      //formgear_js
      let config = {
        clientMode: 2,
        token: ``,
        baseUrl: ``,
        baseUrlFile: ``,
        lookupKey: `key%5B%5D`,
        lookupValue: `value%5B%5D`,
        lookupMode: 2,
        username: Android.getUserName(),
        formMode: Android.getFormMode(),
        initialMode: Android.getIsNew(),
        assignmentID : '',
        principalCollection: JSON.parse(Android.getPrincipalCollection()),
        rolePetugas: Android.getRolePetugas()
      };

      var responseGear = null;
      var mediaGear = null;
      var remarkGear = null;
      var principalGear = null;
      var referenceGear = null;

      function openCamera(filename) {
        window.Android.action("CAMERA", "", filename, "");
        console.log("open camera");
      }

      let gpsHandler = function (setter, isPhoto) {
        console.log("camera handler", setter);
        (isPhoto = false), (cameraGPSFunction = setter);
        openCameraGPS(isPhoto);
      };

      function openCameraGPS(needPhoto) {
        var isNeedPhoto = false;
        if (needPhoto !== null && needPhoto !== undefined)
          isNeedPhoto = needPhoto;
        console.log("new-capi: open-camera-gps " + isNeedPhoto.toString());

        window.Android.action("CAMERA_GPS", "", isNeedPhoto.toString(), "");
      }

      let cameraHandler = function (setValue, filename) {
        console.log("camera handler", setValue);
        cameraFunction = setValue;
        openCamera(filename);
      };

      //function to upload file on Mobile
      let fileUploadHandler = function (files, updateMedia, isReload) {
        console.log('media content', files);
        console.log('media callback ', updateMedia)
        console.log('media isReload ', isReload )
        fileUploadedFunction = updateMedia
        if (isReload) {
          window.Android.action(
            "FILE_RELOAD",
            "",
            JSON.stringify(files),
            ""
          )
        } else {
          window.Android.action(
            "FILE_UPLOAD",
            "",
            JSON.stringify(files),
            ""
          )
        }
       
      }

      let mobileExit = (fun) => {
        mobileExitFunction = fun;
      };

      let setResponseMobile = function (res, med, rem, princ, ref) {
        responseGear = res;
        mediaGear = med;
        remarkGear = rem;
        principalGear = princ;
        referenceGear = ref;

        console.log("response save", responseGear);
        console.log("media", mediaGear);
        console.log("remark save", remarkGear);
        console.log("principal save", principalGear);
        console.log("reference save", referenceGear);

        window.Android.saveOrSubmit(
          JSON.stringify(responseGear),
           JSON.stringify(remarkGear), 
           JSON.stringify(principalGear), 
           JSON.stringify(referenceGear), 
           JSON.stringify(mediaGear),
           "SAVE"
        )
      };

      let setSubmitMobile = function (res, med, rem, princ, ref) {
        responseGear = res;
        mediaGear = med;
        remarkGear = rem;
        principalGear = princ;
        referenceGear = ref;

        console.log("response submit", responseGear);
        console.log("media", mediaGear);
        console.log("remark submit", remarkGear);
        console.log("principal submit", principalGear);
        console.log("reference submit", referenceGear);

        window.Android.saveOrSubmit(
          JSON.stringify(responseGear),
           JSON.stringify(remarkGear), 
           JSON.stringify(principalGear), 
           JSON.stringify(referenceGear), 
           JSON.stringify(mediaGear),
           "SUBMIT"
        )
      };

      let openMap = function (koordinat) {
        window.Android.action("OPEN_MAPS", "", JSON.stringify(koordinat), "");
      };

      function saveData() {
        window.Android.action(
          "SAVE_DATA",
          "",
          JSON.stringify(setResponseMobile),
          ""
        );
      }

      const clientAction = {
        cameraHandler,
        gpsHandler,
        mobileExit,
        setResponseMobile,
        setSubmitMobile,
        openMap,
        fileUploadHandler
      }

      function initForm(
        reference,
        template,
        preset,
        response,
        validation,
        media,
        remark
      ) {
        let form = new FormGear(
          reference,
          template,
          preset,
          response,
          validation,
          media,
          remark,
          config,
          clientAction
        );
        return form;
      }

      const callAndroidFunction = (name) => {
        try {
          const result = Android[name]()
          if (!result) throw new Error()
          return JSON.parse(result)
        } catch (e) {
          console.log(`${name} error:`, e)
          return {}
        }
      }

      const data = Promise.all([
        callAndroidFunction("getReference"),
        callAndroidFunction("getTemplate"),
        callAndroidFunction("getPreset"),
        callAndroidFunction("getResponse"),
        callAndroidFunction("getValidation"),
        callAndroidFunction("getMedia"),
        callAndroidFunction("getRemark")
      ])

      data.then(
        ([reference, template, preset, response, validation, media, remark]) =>
        initForm(
          reference,
          template,
          preset,
          response,
          validation,
          media,
          remark
        )
      );
    </script>
    <script type="text/javascript">
      let cameraFunction = null;
      let cameraGPSFunction = null;
      let mobileExitFunction = null;
      let fileUploadedFunction = null

      function result(action, result, customData) {
        if (action == "GET_LOC") {
          resultGps(result);
        } else if (action == "CAMERA") {
          resultCamera(result, customData);
        } else if (action == "CAMERA_GPS") {
          resultCameraGPS(result);
        } else if (action == "SIGNATURE") {
          resultSignature(result);
        } else if (action == "BARCODE") {
          resultBarcode(result);
        } else if (action == "AUDIO") {
          resultAudio(result);
        } else if (action == "GET_ANSWER") {
          resultAnswer(result, customData);
        } else if (action == "LOOKUP") {
          resultAnswer(result, customData);
        } else if (action == "FILE_UPLOADED") {
          resultFileUpload(result, customData)
        }
      }

      function resultCamera(result, filename) {
        if (cameraFunction != null) {
          cameraFunction(result, filename);
        } else {
          console.log("camera_result_funcion : null");
        }
      }

      function resultCameraGPS(result) {
        const obj = JSON.parse(result);
        var remark = obj.remark;
        cameraGPSFunction(obj, remark);
      }

      function mobileExitAndroid() {
        console.log("mobileExit");
        mobileExitFunction();
      }

      function approveRejectAndroid() {
        mobileExitFunction();
      }

      function resultFileUpload(result, customData) {
        if (fileUploadedFunction != null) {
          const isReload = (customData == 'true' ? true : false)
          console.log(isReload)
          fileUploadedFunction(result, isReload)
        } else {
          console.log("file uploaded function : null")
        }
      }
    </script>
  </body>

</html>